import streamlit as st
import pandas as pd
from datetime import datetime
from PIL import Image
import google.generativeai as genai
from google.oauth2 import service_account
from googleapiclient.discovery import build
from google.cloud import storage
import io
import json

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö ---
st.set_page_config(page_title="Cactus Collector (Free Tier)", page_icon="üåµ")

# ‚ö†Ô∏è‚ö†Ô∏è ‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠ BUCKET ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á (‡πÄ‡∏ä‡πà‡∏ô 'cactus-free-storage-2025') ‚ö†Ô∏è‚ö†Ô∏è
BUCKET_NAME = "cactus-free-storage-2025"

try:
    GEMINI_API_KEY = st.secrets["gemini_api_key"]
    SHEET_ID = st.secrets["sheet_id"]
    # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Service Account ‡∏à‡∏≤‡∏Å Secrets
    GCP_CREDS_DICT = dict(st.secrets["gcp_service_account"])
except Exception as e:
    st.error(f"Secret Error: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Secrets ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ({e})")
    st.stop()

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ AI ‡πÅ‡∏•‡∏∞ Google Cloud
genai.configure(api_key=GEMINI_API_KEY)
creds = service_account.Credentials.from_service_account_info(GCP_CREDS_DICT)

# --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô Cloud Storage (Free Tier Zone) ---
def upload_to_bucket(file_obj, filename):
    try:
        # ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Bucket
        client = storage.Client(credentials=creds, project=GCP_CREDS_DICT["project_id"])
        bucket = client.bucket(BUCKET_NAME)
        blob = bucket.blob(filename)
        
        # ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
        file_obj.seek(0)
        blob.upload_from_file(file_obj, content_type='image/jpeg')
        
        # ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÅ‡∏ö‡∏ö Public ‡∏î‡∏π‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
        return f"https://storage.googleapis.com/{BUCKET_NAME}/{filename}"
    except Exception as e:
        return f"Upload Error: {e}"

# --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Google Sheet ---
def append_to_sheet(data_row):
    service = build('sheets', 'v4', credentials=creds)
    sheet = service.spreadsheets()
    body = {'values': [data_row]}
    sheet.values().append(
        spreadsheetId=SHEET_ID,
        range="Sheet1!A:E", # A=Date, B=PotNo, C=Species, D=ThaiName, E=ImageLink
        valueInputOption="USER_ENTERED",
        body=body
    ).execute()

# --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡πâ AI ‡∏≠‡πà‡∏≤‡∏ô‡∏†‡∏≤‡∏û ---
def analyze_image(image):
    model = genai.GenerativeModel('gemini-1.5-flash')
    prompt = """
    Analyze this cactus image.
    1. Read sequence number on pot label (as integer string).
    2. Identify Species (Scientific Name).
    3. Identify Thai Name.
    Return JSON format: {"pot_number": "...", "species": "...", "thai_name": "..."}
    """
    response = model.generate_content([prompt, image])
    try:
        text = response.text.strip()
        # ‡∏•‡πâ‡∏≤‡∏á format markdown ‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        if text.startswith("```json"): text = text[7:-3]
        return json.loads(text)
    except:
        return {"pot_number": "", "species": "Unknown", "thai_name": "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠"}

# --- 5. ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏≠‡∏û‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô ---
st.title("üåµ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Ñ‡∏Ñ‡∏ï‡∏±‡∏™ (Free Zone)")
st.caption(f"Storage Bucket: {BUCKET_NAME} (US-Central1)")

uploaded_file = st.file_uploader("‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û", type=["jpg", "jpeg", "png"])

if uploaded_file is not None:
    image = Image.open(uploaded_file)
    st.image(image, caption="‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", width=300)
    
    # ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÉ‡∏´‡πâ AI ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    if st.button("üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"):
        with st.spinner('AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå...'):
            st.session_state['ai_result'] = analyze_image(image)
            st.success("‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!")

    # ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if 'ai_result' in st.session_state:
        data = st.session_state['ai_result']
        
        with st.form("save_data_form"):
            col1, col2 = st.columns(2)
            pot_no = col1.text_input("‡πÄ‡∏•‡∏Ç‡∏Å‡∏£‡∏∞‡∏ñ‡∏≤‡∏á", data.get('pot_number'))
            species = col2.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", data.get('species'))
            thai_name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢", data.get('thai_name'))
            
            submit_btn = st.form_submit_button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û")
            
            if submit_btn:
                with st.spinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...'):
                    # 1. ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ (‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏°‡∏≤‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢)
                    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                    filename = f"Cactus_{pot_no}_{timestamp}.jpg"
                    
                    # 2. ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                    img_byte = io.BytesIO()
                    image.save(img_byte, format='JPEG')
                    
                    # 3. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Bucket
                    img_link = upload_to_bucket(img_byte, filename)
                    
                    if "Upload Error" in img_link:
                        st.error(f"‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: {img_link}")
                    else:
                        # 4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Sheet
                        current_date = str(datetime.today().date())
                        append_to_sheet([current_date, pot_no, species, thai_name, img_link])
                        
                        st.success(f"‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà {pot_no} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!")
                        st.info(f"‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ: {img_link}") # ‡πÇ‡∏ä‡∏ß‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
                        
                        # ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ AI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà
                        del st.session_state['ai_result']
