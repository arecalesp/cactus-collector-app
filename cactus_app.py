import streamlit as st
import pandas as pd
from datetime import datetime
from PIL import Image, ImageOps
import google.generativeai as genai
from google.oauth2 import service_account
from googleapiclient.discovery import build
from google.cloud import storage
import io
import json
import time

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ---
st.set_page_config(page_title="Cactus Collector (Auto-Fix)", page_icon="üåµ")

BUCKET_NAME = "cactus-free-storage-2025" 

if 'uploader_key' not in st.session_state:
    st.session_state['uploader_key'] = 0

try:
    GEMINI_API_KEY = st.secrets["gemini_api_key"]
    SHEET_ID = st.secrets["sheet_id"]
    GCP_CREDS_DICT = dict(st.secrets["gcp_service_account"])
except Exception as e:
    st.error(f"Secret Error: {e}")
    st.stop()

genai.configure(api_key=GEMINI_API_KEY)
creds = service_account.Credentials.from_service_account_info(GCP_CREDS_DICT)

# --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô "‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï" (‡∏´‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á) ---
def find_working_model():
    # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏´‡∏≤‡πÄ‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤
    if 'working_model_name' in st.session_state:
        return st.session_state['working_model_name']

    status_text = st.empty()
    status_text.warning("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ... (‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)")
    
    try:
        # 1. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ
        all_models = [m for m in genai.list_models() if 'generateContent' in m.supported_generation_methods]
        
        # ‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö: ‡πÄ‡∏≠‡∏≤‡∏û‡∏ß‡∏Å Flash ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î)
        # ‡πÅ‡∏ï‡πà‡∏Å‡∏£‡∏≠‡∏á‡∏û‡∏ß‡∏Å Experimental ‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡πÑ‡∏î‡πâ
        sorted_models = sorted(all_models, key=lambda x: ('flash' not in x.name, 'exp' in x.name))
        
        # 2. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏ó‡∏™‡∏ó‡∏µ‡∏•‡∏∞‡∏ï‡∏±‡∏ß
        for m in sorted_models:
            model_name = m.name
            friendly_name = model_name.replace('models/', '')
            
            # ‡∏Ç‡πâ‡∏≤‡∏°‡∏û‡∏ß‡∏Å 2.0 / 2.5 / exp ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏£‡∏≤‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (‡∏•‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏î‡∏π‡∏Å‡πà‡∏≠‡∏ô)
            if '2.0' in friendly_name or '2.5' in friendly_name or 'exp' in friendly_name:
                continue

            try:
                # ‡∏•‡∏≠‡∏á‡∏¢‡∏¥‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡∏≠‡∏á
                test_model = genai.GenerativeModel(model_name)
                response = test_model.generate_content("test")
                
                if response.text:
                    # ‡∏ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÑ‡∏î‡πâ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡πÅ‡∏´‡∏•‡∏∞! ‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å!
                    st.session_state['working_model_name'] = friendly_name
                    status_text.success(f"‡πÄ‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß! ‡πÉ‡∏ä‡πâ‡πÇ‡∏°‡πÄ‡∏î‡∏•: {friendly_name}")
                    time.sleep(1)
                    status_text.empty()
                    return friendly_name
            except:
                continue # ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏û‡∏±‡∏á ‡πÑ‡∏õ‡∏ï‡∏±‡∏ß‡∏ï‡πà‡∏≠‡πÑ‡∏õ
        
        # ‡∏ñ‡πâ‡∏≤‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏û‡∏ß‡∏Å Stable ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÄ‡∏•‡∏¢... ‡πÄ‡∏≠‡πâ‡∏≤! ‡∏¢‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏û‡∏ß‡∏Å exp ‡∏Å‡πá‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πâ‡∏ï‡∏≤‡∏¢‡∏Å‡πâ‡∏ô‡∏Å‡∏∏‡∏è‡∏¥)
        for m in sorted_models:
             model_name = m.name.replace('models/', '')
             try:
                test_model = genai.GenerativeModel(model_name)
                test_model.generate_content("test")
                st.session_state['working_model_name'] = model_name
                return model_name
             except:
                continue

    except Exception as e:
        st.error(f"System Error: {e}")
    
    status_text.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á API Key ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà)")
    return None

# --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Cloud Storage ---
def upload_to_bucket(file_obj, filename):
    try:
        client = storage.Client(credentials=creds, project=GCP_CREDS_DICT["project_id"])
        bucket = client.bucket(BUCKET_NAME)
        blob = bucket.blob(filename)
        file_obj.seek(0)
        blob.upload_from_file(file_obj, content_type='image/jpeg')
        return f"https://storage.googleapis.com/{BUCKET_NAME}/{filename}"
    except Exception as e:
        return f"Upload Error: {e}"

# --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Google Sheet ---
def append_to_sheet(data_row):
    service = build('sheets', 'v4', credentials=creds)
    sheet = service.spreadsheets()
    body = {'values': [data_row]}
    sheet.values().append(
        spreadsheetId=SHEET_ID,
        range="Sheet1!A:E",
        valueInputOption="USER_ENTERED",
        body=body
    ).execute()

# --- 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô AI (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏´‡∏≤‡πÄ‡∏à‡∏≠) ---
def analyze_image(image):
    model_name = find_working_model()
    
    if not model_name:
        return {"pot_number": "", "species": "Account Error", "thai_name": "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô API Key ‡πÄ‡∏ñ‡∏≠‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö"}

    try:
        model = genai.GenerativeModel(model_name)
        prompt = """
        You are a Cactus expert. Look at the image directly.
        1. Find 'Sequence Number' on the tag (digits only).
        2. Identify 'Scientific Name' based on appearance (e.g. Astrophytum asterias).
        3. Identify 'Thai Name' (e.g. ‡πÅ‡∏≠‡∏™‡πÇ‡∏ï‡∏£).
        Return ONLY JSON: {"pot_number": "...", "species": "...", "thai_name": "..."}
        """
        response = model.generate_content([prompt, image])
        text = response.text.strip()
        if text.startswith("```json"): text = text[7:-3]
        return json.loads(text)
    except Exception as e:
        # ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏ó‡∏™‡∏ú‡πà‡∏≤‡∏ô ‡∏î‡∏±‡∏ô‡∏°‡∏≤‡∏ï‡∏≤‡∏¢‡∏ï‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤
        if 'working_model_name' in st.session_state:
            del st.session_state['working_model_name']
        return {"pot_number": "", "species": f"Error: {e}", "thai_name": ""}

# --- 6. ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏≠‡∏û ---
st.title("üåµ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Ñ‡∏Ñ‡∏ï‡∏±‡∏™ (Self-Healing)")

uploaded_file = st.file_uploader(
    "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û", 
    type=["jpg", "jpeg", "png"],
    key=f"uploader_{st.session_state['uploader_key']}"
)

if uploaded_file is not None:
    image = Image.open(uploaded_file)
    image = ImageOps.exif_transpose(image)
    st.image(image, caption="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û", width=300)
    
    # Auto Run
    if 'last_analyzed_file' not in st.session_state or st.session_state['last_analyzed_file'] != uploaded_file.name:
        # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å AI ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏°‡∏±‡∏ô‡∏à‡∏∞‡πÑ‡∏õ‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÄ‡∏≠‡∏á)
        with st.spinner('ü§ñ AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...'):
            st.session_state['ai_result'] = analyze_image(image)
            st.session_state['last_analyzed_file'] = uploaded_file.name
            
    # Form
    if 'ai_result' in st.session_state:
        data = st.session_state['ai_result']
        with st.form("save_form"):
            c1, c2 = st.columns(2)
            pot_no = c1.text_input("‡πÄ‡∏•‡∏Ç‡∏Å‡∏£‡∏∞‡∏ñ‡∏≤‡∏á", data.get('pot_number'))
            species = c2.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ó‡∏¢‡πå", data.get('species'))
            thai = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢", data.get('thai_name'))
            
            if st.form_submit_button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"):
                with st.spinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'):
                    ts = datetime.now().strftime("%Y%m%d_%H%M%S")
                    fname = f"Cactus_{pot_no}_{ts}.jpg"
                    img_byte = io.BytesIO()
                    image.save(img_byte, format='JPEG') 
                    link = upload_to_bucket(img_byte, fname)
                    
                    today = str(datetime.today().date())
                    append_to_sheet([today, pot_no, species, thai, link])
                    
                    st.success(f"‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!")
                    
                    if 'ai_result' in st.session_state: del st.session_state['ai_result']
                    if 'last_analyzed_file' in st.session_state: del st.session_state['last_analyzed_file']
                    st.session_state['uploader_key'] += 1
                    time.sleep(1) 
                    st.rerun()
